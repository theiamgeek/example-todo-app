version: 0.2
env:
  variables:
    CONT_NAME: "todo-app"
    DEPLOYMENT_SUBNETS: "\"subnet-038928ad2a03712a0\",\"subnet-078635a58e7f78177\""
    DEPLOYMENT_SGS: "\"sg-07e8b034d9a8af9ae\""
    TASK_NAME: "todo-app"
    TASK_EXEC_ROLE: "arn:aws:iam::904948009583:role/ecsTaskExecutionRole"
    MONGO_DB_URL_ARN: "arn:aws:ssm:us-east-1:904948009583:parameter/docdbsecret"
    CONT_LOG_GP: "/ecs/first-run-task-definition"
    CONT_LOG_STRM_PFIX: "ecs"
phases:
  install:
    runtime-versions:
      nodejs: 12
  pre_build:
    commands:
      - echo Logging in to Amazon ECR...
      - $(aws ecr get-login --no-include-email --region $AWS_REGION)
  build:
    commands:
      - echo Build started on `date`
      - echo Building nodejs application...
      - npm install
      - npm run build-server
      - npm run build-public
      - npm run build-sass
      - npm run build-client
      - npm run build-content
      - echo Building Docker image $IMAGE_REPO_NAME:$CODEBUILD_BUILD_NUMBER
      - docker build --progress plain --tag $IMAGE_REPO_NAME:$CODEBUILD_BUILD_NUMBER .
      - echo tagging Docker image $IMAGE_REPO_NAME:$CODEBUILD_BUILD_NUMBER to go into $IMAGE_REPO_NAME:$CODEBUILD_BUILD_NUMBER $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$IMAGE_REPO_NAME:$CODEBUILD_BUILD_NUMBER
      - docker tag $IMAGE_REPO_NAME:$CODEBUILD_BUILD_NUMBER $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$IMAGE_REPO_NAME:$CODEBUILD_BUILD_NUMBER
  post_build:
    commands:
      - echo Build completed on `date`
      - echo Pushing Docker image...
      - docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$IMAGE_REPO_NAME:$CODEBUILD_BUILD_NUMBER
      - echo Filling Task Definition template...
      - envsubst < taskdef_template.json > taskdef.json
      - echo Exporting new Task Definition to ECS...
      - export TASK_DEF=`aws ecs register-task-definition --cli-input-json file://taskdef.json --region "$AWS_REGION" | jq -r .taskDefinition.taskDefinitionArn`
      - echo Filling Application Specification template...
      - envsubst < appspec_template.json > appspec.json
artifacts:
  files:
    - 'public/**/*'
  secondary-artifacts:
    appspec:
      files:
        - appspec.json

